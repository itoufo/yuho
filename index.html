<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼Šæ±é›„æ­© Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav>
    <div class="container nav-inner">
      <a href="index.html" class="logo">ğŸš€ ä¼Šæ±é›„æ­©</a>
      <div class="links">
        <a href="index.html" class="active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <a href="articles.html">è¨˜äº‹ç®¡ç†</a>
        <a href="branding.html">ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</a>
        <a href="account-design.html">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­è¨ˆ</a>
        <a href="profile.html">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

    <div class="grid grid-4" id="stats">
      <div class="card stat-card">
        <div class="stat-number" id="total-count">-</div>
        <div class="stat-label">ç·è¨˜äº‹æ•°</div>
      </div>
      <div class="card stat-card">
        <div class="stat-number" id="idea-count">-</div>
        <div class="stat-label">ã‚¢ã‚¤ãƒ‡ã‚¢</div>
      </div>
      <div class="card stat-card">
        <div class="stat-number" id="drafting-count">-</div>
        <div class="stat-label">åŸ·ç­†ä¸­</div>
      </div>
      <div class="card stat-card">
        <div class="stat-number" id="published-count">-</div>
        <div class="stat-label">å…¬é–‹æ¸ˆã¿</div>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">
          <h2>ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ¥</h2>
        </div>
        <table>
          <thead><tr><th>ã‚¿ã‚¤ãƒ—</th><th>è¨˜äº‹æ•°</th></tr></thead>
          <tbody id="branding-stats"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>æœ€è¿‘ã®æ›´æ–°</h2>
          <a href="articles.html" class="btn btn-secondary btn-sm">ã™ã¹ã¦è¦‹ã‚‹</a>
        </div>
        <table>
          <thead><tr><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead>
          <tbody id="recent-articles"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
      </div>
      <div class="actions">
        <a href="articles.html?action=new" class="btn btn-primary">+ æ–°è¦è¨˜äº‹</a>
        <a href="articles.html?status=drafting" class="btn btn-secondary">åŸ·ç­†ä¸­ã‚’è¦‹ã‚‹</a>
        <a href="articles.html?status=idea" class="btn btn-secondary">ã‚¢ã‚¤ãƒ‡ã‚¢ä¸€è¦§</a>
      </div>
    </div>

    <div class="card" id="suggestions-section">
      <div class="card-header">
        <h2>ğŸ“ æ›¸ãã¹ãè¨˜äº‹ï¼ˆå„ªå…ˆé †ä½é †ï¼‰</h2>
        <button class="btn btn-secondary btn-sm" onclick="loadSuggestions()">æ›´æ–°</button>
      </div>
      <div id="suggestions-list">
        <p class="empty">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <div class="card" id="drafts-section">
      <div class="card-header">
        <h2>note.com æŠ•ç¨¿ç”¨ä¸‹æ›¸ã</h2>
      </div>
      <div id="drafts-list"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/app.js"></script>
  <script src="js/drafts.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // çµ±è¨ˆæƒ…å ±å–å¾—
      const { data: articles } = await supabaseClient.from('yuho_articles').select('*');

      if (articles) {
        document.getElementById('total-count').textContent = articles.length;
        document.getElementById('idea-count').textContent = articles.filter(a => a.status === 'idea').length;
        document.getElementById('drafting-count').textContent = articles.filter(a => a.status === 'drafting').length;
        document.getElementById('published-count').textContent = articles.filter(a => a.status === 'published').length;

        // ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ¥
        const byBranding = {};
        articles.forEach(a => {
          const key = a.branding_type || 'none';
          byBranding[key] = (byBranding[key] || 0) + 1;
        });

        const brandingHtml = Object.entries(byBranding).map(([type, count]) => `
          <tr>
            <td><span class="badge badge-${type}">${type === 'none' ? 'æœªåˆ†é¡' : type}</span></td>
            <td>${count}</td>
          </tr>
        `).join('');
        document.getElementById('branding-stats').innerHTML = brandingHtml || '<tr><td colspan="2" class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';

        // æœ€è¿‘ã®æ›´æ–°
        const recent = articles.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at)).slice(0, 5);
        const recentHtml = recent.map(a => `
          <tr>
            <td><a href="articles.html?id=${a.id}">${a.title.substring(0, 40)}${a.title.length > 40 ? '...' : ''}</a></td>
            <td><span class="badge badge-${a.status}">${a.status}</span></td>
          </tr>
        `).join('');
        document.getElementById('recent-articles').innerHTML = recentHtml || '<tr><td colspan="2" class="empty">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      }

      // ä¸‹æ›¸ãè¡¨ç¤º
      renderDrafts();

      // è¨˜äº‹ææ¡ˆã‚’èª­ã¿è¾¼ã¿
      loadSuggestions();
    });

    async function loadSuggestions() {
      const container = document.getElementById('suggestions-list');
      container.innerHTML = '<p class="empty">èª­ã¿è¾¼ã¿ä¸­...</p>';

      const { data, error } = await supabaseClient
        .from('yuho_article_suggestions')
        .select('*')
        .neq('status', 'completed')
        .neq('status', 'skipped')
        .order('priority', { ascending: false })
        .limit(10);

      if (error) {
        container.innerHTML = '<p class="empty">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p class="empty">ææ¡ˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = data.map(s => `
        <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="background:${s.priority >= 90 ? '#ef4444' : s.priority >= 80 ? '#f97316' : s.priority >= 70 ? '#eab308' : '#22c55e'};color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:bold;">
                  ${s.priority}
                </span>
                <span class="badge badge-${s.branding_type}">${s.branding_type}</span>
                <span class="badge" style="background:#f1f5f9;color:#64748b;">${s.category}</span>
                ${s.impact === 'high' ? '<span style="color:#ef4444;font-size:0.8rem;">ğŸ”¥ é«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ</span>' : ''}
              </div>
              <h4 style="margin:0 0 8px 0;font-size:1rem;">${s.title}</h4>
              <p style="margin:0 0 8px 0;color:#6b7280;font-size:0.9rem;">${s.description}</p>
              <div style="display:flex;gap:4px;flex-wrap:wrap;">
                ${(s.tags || []).map(t => `<span style="background:#e2e8f0;color:#475569;padding:2px 6px;border-radius:4px;font-size:0.75rem;">${t}</span>`).join('')}
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;">
              <button class="btn btn-sm btn-primary" onclick="updateSuggestionStatus(${s.id}, 'writing')">åŸ·ç­†é–‹å§‹</button>
              <button class="btn btn-sm btn-secondary" onclick="updateSuggestionStatus(${s.id}, 'skipped')">ã‚¹ã‚­ãƒƒãƒ—</button>
            </div>
          </div>
          ${s.notes ? `<p style="margin:8px 0 0;padding:8px;background:#f8fafc;border-radius:4px;font-size:0.85rem;color:#64748b;">ğŸ’¡ ${s.notes}</p>` : ''}
        </div>
      `).join('');
    }

    async function updateSuggestionStatus(id, status) {
      const { error } = await supabaseClient
        .from('yuho_article_suggestions')
        .update({ status: status })
        .eq('id', id);

      if (error) {
        alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
        return;
      }

      loadSuggestions();
    }

    function renderDrafts() {
      const drafts = getDrafts();
      const container = document.getElementById('drafts-list');

      if (drafts.length === 0) {
        container.innerHTML = '<p class="empty">ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = drafts.map(draft => `
        <div class="draft-item" style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;">
          <div style="display:flex;gap:16px;align-items:flex-start;">
            <img src="${draft.thumbnail}" style="width:120px;height:68px;object-fit:cover;border-radius:6px;" onerror="this.style.display='none'">
            <div style="flex:1;">
              <h3 style="margin:0 0 8px 0;font-size:1.1rem;">${draft.title}</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                <span class="badge badge-${draft.branding}">${draft.branding}</span>
                ${draft.tags.map(t => `<span class="badge" style="background:#f1f5f9;color:#64748b;">${t}</span>`).join('')}
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-sm btn-primary" onclick="copyToClipboard('${draft.title.replace(/'/g, "\\'")}', this)">ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${draft.tags.join(', ')}', this)">ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-sm btn-secondary" onclick="showDraftModal('${draft.id}')">æœ¬æ–‡ã‚’è¡¨ç¤º</button>
                <button class="btn btn-sm btn-secondary" onclick="showImagesModal('${draft.id}')">ç”»åƒä¸€è¦§</button>
                ${draft.xPost ? `<button class="btn btn-sm btn-secondary" style="background:#000;color:#fff;" onclick="showXPostModal('${draft.id}')">XæŠ•ç¨¿</button>` : ''}
                <a href="https://note.com/notes/new" target="_blank" class="btn btn-sm btn-secondary">note.comã§ä½œæˆ</a>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showDraftModal(id) {
      const draft = getDraftById(id);
      if (!draft) return;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
      modal.innerHTML = `
        <div style="background:white;border-radius:12px;max-width:800px;width:90%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
          <div style="padding:16px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">${draft.title}</h3>
            <button onclick="this.closest('.modal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <div style="padding:16px 24px;border-bottom:1px solid #e2e8f0;display:flex;gap:8px;">
            <button class="btn btn-primary" onclick="copyToClipboard(getDraftById('${id}').content, this)">æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆMarkdownï¼‰</button>
            <button class="btn btn-secondary" id="toggle-preview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</button>
          </div>
          <div id="draft-content" style="padding:24px;overflow-y:auto;flex:1;">
            <pre style="white-space:pre-wrap;font-family:inherit;margin:0;">${draft.content}</pre>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
      let showPreview = false;
      document.getElementById('toggle-preview').onclick = function() {
        showPreview = !showPreview;
        const contentDiv = document.getElementById('draft-content');
        if (showPreview) {
          contentDiv.innerHTML = '<div class="article-preview">' + marked.parse(draft.content) + '</div>';
          this.textContent = 'Markdownè¡¨ç¤º';
        } else {
          contentDiv.innerHTML = '<pre style="white-space:pre-wrap;font-family:inherit;margin:0;">' + draft.content + '</pre>';
          this.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º';
        }
      };
    }

    function showXPostModal(id) {
      const draft = getDraftById(id);
      if (!draft || !draft.xPost) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
      modal.innerHTML = \`
        <div style="background:white;border-radius:12px;max-width:500px;width:90%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
          <div style="padding:16px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#000;color:#fff;">
            <h3 style="margin:0;">XæŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</h3>
            <button onclick="this.closest('.modal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#fff;">&times;</button>
          </div>
          <div style="padding:24px;overflow-y:auto;flex:1;">
            <pre style="white-space:pre-wrap;font-family:inherit;margin:0 0 16px 0;background:#f8f9fa;padding:16px;border-radius:8px;">\${draft.xPost}</pre>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-primary" style="background:#000;" onclick="copyToClipboard(getDraftById('\${id}').xPost, this)">ã‚³ãƒ”ãƒ¼</button>
              <a href="https://twitter.com/intent/tweet?text=\${encodeURIComponent(draft.xPost)}" target="_blank" class="btn btn-secondary">Xã§æŠ•ç¨¿</a>
            </div>
            <p style="color:#6b7280;font-size:0.85rem;margin-top:16px;">\${draft.xPost.length}/280æ–‡å­—</p>
          </div>
        </div>
      \`;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    }

    function showImagesModal(id) {
      const draft = getDraftById(id);
      if (!draft || !draft.images) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
      modal.innerHTML = `
        <div style="background:white;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
          <div style="padding:16px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">ç”»åƒä¸€è¦§ï¼ˆnoteæŠ•ç¨¿ç”¨ï¼‰</h3>
            <button onclick="this.closest('.modal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <div style="padding:24px;overflow-y:auto;flex:1;">
            ${draft.images.map(img => `
              <div style="margin-bottom:16px;padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                  <strong>${img.name}</strong>
                  <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${img.path}', this)">ãƒ‘ã‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>
                <img src="${img.path}" style="width:100%;border-radius:4px;" />
              </div>
            `).join('')}
            <p style="color:#6b7280;font-size:0.9rem;margin-top:16px;">
              note.comã§ã¯ç”»åƒã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚<br>
              Finderã§ <code>dashboard/img/</code> ã‚’é–‹ã„ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã€‚
            </p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    }
  </script>
</body>
</html>
